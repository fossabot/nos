---
version: '3'

env:
  ARCH: '{{.ARCH | default "x86_64"}}'
  BUILD_TYPE: '{{.BUILD_TYPE | default "debug"}}'
  BUILD_DIR: 'build'

dotenv: ['.env']

tasks:
  kernel:setup:
    cmds: 
      - meson setup $BUILD_DIR/kernel/$ARCH/$BUILD_TYPE --buildtype $BUILD_TYPE --cross-file config/$ARCH/kernel.cross-file

  kernel:compile:
    cmds:
      - cd $BUILD_DIR/kernel/$ARCH/$BUILD_TYPE && meson compile kernel.elf

  kernel:image:build:
    cmds:
      - cd $BUILD_DIR/kernel/$ARCH/$BUILD_TYPE && meson compile image

  kernel:image:run:
    cmds:
      - qemu-system-$ARCH -M q35 -m 2G -serial stdio -debugcon file:logs/qemu-debugcon.log -cdrom $BUILD_DIR/kernel/$ARCH/$BUILD_TYPE/image/nos-$ARCH.iso -boot d

  native:setup:
    cmds: 
      - meson setup $BUILD_DIR/native/$BUILD_TYPE --buildtype $BUILD_TYPE --native-file config/native.native-file

  native:compile:
    cmds:
      - cd $BUILD_DIR/native/$BUILD_TYPE && meson compile {{.CLI_ARGS}}

  native:test:
    cmds:
      - cd $BUILD_DIR/native/$BUILD_TYPE && meson test {{.CLI_ARGS}}

  clear:
    cmds:
      - rm -r $BUILD_DIR